var fs = require('fs-extra');
var exec = require('child_process').exec;
var dircompare = require('dir-compare');
var GITTARGET = "http://jdb-dev.com/mars/financialMarket.git";
var copyList = ['node_modules', 'tasks', 'temp-common', 'temp-cordova', 'temp-hybrid-mock', 'temp-lib', 'util', 'package.json', 'index.js', 'config.js', 'eslintrc.config.js'];

function getGit() {
    return new Promise((resolve, reject) => {
        fs.access("./testModule", fs.F_OK, function (err) {
            if (!err) {
                exec("cd testModule\ngit pull", function (err, output) {
                    resolve();
                });
            } else {
                exec("git clone " + GITTARGET + " testModule", function (err, output) {
                    if (err) {
                        throw err;
                    } else {
                        console.log(output);
                        resolve();
                    }
                });
            }
        });
    });
}

function copyGitRepo() {
    return new Promise((resolve, reject) => {
        fs.access("./testModule2", fs.F_OK, function (err) {
            if (!err) {
                resolve();
                return;
            } else {
                fs.copy('./testModule', './testModule2', function (err) {
                    if (err) {
                        throw err;
                    }
                    resolve();
                });
            }
        });
    });
}

function installBuildAndProd() {
    return new Promise((resolve, reject) => {
        exec("cd testModule\nnpm install\nnpm update\ngulp prod", function (err, output) {
            if (err) {
                throw err;
            } else {
                console.log(output);
                resolve();
            }
        });
    });
}

function copyDevBuildAndProd(callback) {
    return new Promise((resolve, reject) => {
        exec("echo 'var gulpTasks = require(\"../index.js\");' > testModule2/gulpfile.js", function (err, output) {
            if (err) {
                throw err;
            } else {
                console.log(output);
                exec("cd testModule2\ngulp prod", function (err, output) {
                    if (err) {
                        throw err;
                    } else {
                        console.log(output);
                    }
                    resolve();
                });
            }
        });
    });
}

function diffCheck() {
    return new Promise((resolve, reject) => {
        var options = {
            compareSize: true
        };
        // var moduleName = require('./testModule/package.json').name;
        var path1 = './testModule/dist/';
        var path2 = './testModule2/dist/';
        dircompare.compare(path1, path2, options).then(function (res) {
            console.log('equal: ' + res.equal);
            console.log('distinct: ' + res.distinct);
            console.log('left: ' + res.left);
            console.log('right: ' + res.right);
            console.log('differences: ' + res.differences);
            console.log('same: ' + res.same);
            var format = require('util').format;
            res.diffSet.forEach(function (entry) {
                var state = {
                    'equal': '==',
                    'left': '->',
                    'right': '<-',
                    'distinct': '<>'
                }[entry.state];
                var name1 = entry.name1 ? entry.name1 : '';
                var name2 = entry.name2 ? entry.name2 : '';
                console.log(format('%s(%s)%s%s(%s)', name1, entry.type1, state, name2, entry.type2));
            });
            resolve();
        }).catch(function (error) {
            console.error(error);
            reject();
        })
    });
}

async function start() {
    await getGit();
    await copyGitRepo();
    await installBuildAndProd();
    await copyDevBuildAndProd();
    await diffCheck();
    // process.exit();
}

start();
