# build脚本及公共库迁移说明

## 迁移原因

### build脚本

原build脚本依赖于脚本git repo master分支的更新，无法分版本管理，并且无法通过`npm update`来进行编译脚本的更新。使用最新版本的编译脚本需要主动通知所有FE成员手动删除node_modules中的build文件夹并重新`npm install`，编译机上的所有项目使用的编译脚本也需要手动更新，非常不便。所以希望通过私有npm package方式引入编译脚本(build)的方式来解决这个问题。

### 公共库

在Android部分机型中，内置webview对于本地资源加载优化不够，资源总大小相同的情况下，资源加载耗时与资源数正相关。原有的分散式的共有库加载方式，DOM ready 时间在800ms上下，将共有库的css、js分别合并后，DOM ready 时间下降到200ms上下。

为了优化端上的Hybrid体验，将原有的共有库js、css分别压缩合并为单个文件进行引入。


## build迁移步骤

1.配置npm registry到私有npm服务

### 使用npm自带配置

```
npm config set registry http://100.73.16.43:4873/

```
### 使用nrm管理npm(推荐）
```
npm install -g nrm
nrm add sinopia http://100.73.16.43:4873/
nrm use sinopia
```
配置完成后使用 `npm install` 将自动通过 sinopia 私有 npm 服务下载依赖的 npm 包，公有包将通过 taobao 源进行下载，有缓存机制。

### 其他

通过私有npm服务安装node-sass没有cnpm来的快，因为cnpm通过自己的源下载node-sass源码包并缓存。
改用私有npm服务后，可以通过添加环境变量
```
export SASS_BINARY_SITE="https://npm.taobao.org/mirrors/node-sass"
```
来解决node-sass安装慢、安装失败的问题

2.修改当前项目模块的package.json的依赖
修改package.json中dependence内的
```
"build": "http://git.jdb-dev.com/uranus/build/repository/archive.tar.gz?ref=master"
```
为
```
"@JDB/build": "^0.1.0"
```
其中 "^0.1.0" 为推荐设置，可根据需要自行调整，非特殊情况推荐使用最新版本。

3.修改gulp中对脚本的引用
修改gulpfile.js中
```
var gulpTasks = require('build');
```
为
```
var gulpTasks = require('@JDB/build');
```
修改完成后`npm install`即可使用迁移后预编译脚本

## 更新

迁移后，通过执行`npm update`就会根据package.json的设置自动更新编译脚本，方便后续各模块的编译脚本维护。

### 公共库迁移

\>=2.5.0版本客户端必须强制使用新公共库。
需要将模块入口html文件中对于原lib、common、cordova下的js、css文件引用删除。
统一使用
```
<link rel="stylesheet" href="../core/core.css">
<script src="../core/core.js"></script>
```
的形式引入新共有库，新共有库中包含所有lib、common、cordova下的文件。